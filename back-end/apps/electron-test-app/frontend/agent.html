<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Agent - Share Screen</title>
        <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    </head>
    <body>
        <h2>Agent Ä‘ang sáºµn sÃ ng chia sáº» mÃ n hÃ¬nh</h2>
        <p id="status">Khá»Ÿi Ä‘á»™ng...</p>

        <script>
            (async () => {
                const agentId = 'agent-1234';
                const peerAgent = new Peer(agentId, {
                    host: '172.16.13.231', // hoáº·c domain
                    port: 8030,
                    path: '/peerjs',
                    secure: false, // náº¿u server cháº¡y HTTP
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            // { urls: 'turn:...', credential: '', username: '' }
                        ],
                    },
                });

                peerAgent.on('open', (id) => {
                    console.log('[Agent] Peer ID:', id);
                    document.getElementById('status').innerText = 'Sáºµn sÃ ng, Peer ID: ' + id;
                });

                // Khi viewer káº¿t ná»‘i qua DataConnection
                peerAgent.on('connection', async (conn) => {
                    console.log('[Agent] Viewer connected via data:', conn.peer);

                    conn.on('data', async (data) => {
                        console.log('[Agent] Nháº­n data:', data);

                        if (data.peerId) {
                            console.log('[Agent] Sáº½ gá»i ngÆ°á»£c láº¡i viewer:', data.peerId);
                            try {
                                const stream = await navigator.mediaDevices.getDisplayMedia({
                                    video: true || {
                                        mandatory: {
                                            chromeMediaSource: 'desktop',
                                            chromeMediaSourceId: 'screen:1:0', // screen.id,
                                        },
                                    },
                                    audio: false,
                                });
                                console.log('ðŸš€ ~ conn.on ~ stream:', stream);
                                const call = peerAgent.call(data.peerId, stream);
                                console.log('ðŸš€ ~ conn.on ~ call:', call);

                                call.on('close', () => {
                                    console.log('[Agent] Viewer Ä‘Ã£ ngáº¯t káº¿t ná»‘i');
                                    stream.getTracks().forEach((t) => t.stop());
                                });
                            } catch (err) {
                                console.error('[Agent] Lá»—i khi láº¥y mÃ n hÃ¬nh:', err);
                            }
                        }
                    });
                });

                peerAgent.on('call', async (call) => {
                    console.log('[Agent] CÃ³ viewer gá»i tá»›i:', call.peer);
                    try {
                        const stream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: false,
                        });
                        console.log('[Agent] ÄÃ£ láº¥y Ä‘Æ°á»£c stream mÃ n hÃ¬nh:', stream);
                        call.answer(stream);

                        call.on('close', () => {
                            console.log('[Agent] Viewer Ä‘Ã£ ngáº¯t káº¿t ná»‘i');
                            stream.getTracks().forEach((t) => t.stop());
                        });
                    } catch (err) {
                        console.error('[Agent] Lá»—i khi láº¥y mÃ n hÃ¬nh:', err);
                    }
                });

                peerAgent.on('error', (err) => {
                    console.error('[Agent] Peer error:', err);
                    document.getElementById('status').innerText = 'Lá»—i: ' + err;
                });
            })();
        </script>
    </body>
</html>
